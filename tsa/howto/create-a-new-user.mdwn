[[!toc]]

This document explains how to create new shell (and email) accounts.
See also [[doc/accounts]] to evaluate new account requests.

# Configuration

This should be done only once.

    git clone git@git-rw.torproject.org:admin/account-keyring.git
    git -C account-keyring remote add alberti alberti.torproject.org:srv/db.torproject.org/keyrings/keyring.git

It downloads the git repository that manages the OpenPGP keyring. This
keyring is essential as it allows users to interact with the LDAP
database securely to perform password changes and is also used to send
the initial password for new accounts.

# Creating a new user

This procedure can be used to create a real account for a human
being. If this is for a machine or another automated thing, create a
role account (see below).

To create a new user, specific information need to be provided by the
requestee, as detailed in [[doc/accounts]].

The short version is:

    # THIS KEY SHOULD BE CHECKED, SEE BELOW FOR DETAILS
    FINGERPRINT=0123456789ABCDEF0123456789ABCDEF01234567 &&
    NEW_USER=alice &&
    REQUESTOR=bob &&
    gpg --export-options export-minimal --no-armor --export "$FINGERPRINT" > "${NEW_USER}-${FINGERPRINT}.gpg" && 
    git add "${NEW_USER}-${FINGERPRINT}.gpg" &&
    git commit -m"new user ${NEW_USER} requested by ${REQUESTOR}" &&
    git push &&
    git push alberti &&
    ssh -tt alberti.torproject.org "ud-useradd -n && sudo -u sshdist ud-generate && sudo -H ud-replicate" &&
    ssh -tt eugeni.torproject.org "sudo -H ud-replicate && egrep -q "${USER}@torproject.org" /etc/postfix/debian || echo "new user missing, please fix" && sudo puppet agent -t

See below for detailed instructions.

## on your own machine

For example, your laptop.

  1. verify the OpenPGP key provided
  
     It should be signed by a trusted key in the keyring or in a
     message signed by a trusted key. See [[doc/accounts]] when
     unsure.

  2. add pgp key to the `account-keyring` repository:

         FINGERPRINT=0123456789ABCDEF0123456789ABCDEF01234567
        NEW_USER=alice
        REQUESTOR=bob
        gpg --export-options export-minimal --no-armor --export "$FINGERPRINT" > "${NEW_USER}-${FINGERPRINT}.gpg"
        git add "${NEW_USER}-${FINGERPRINT}.gpg"
        git commit -m"new user ${NEW_USER} requested by ${REQUESTOR}"

  3. push to both repositories:
  
         git push
        git push alberti

## on the LDAP server

This is currently `alberti`. Make sure you run as a regular user with
LDAP write access.

  1. create the user:
  
         ud-useradd -n

     This command asks a bunch of questions interactively that have
     good defaults, mostly taken from the OpenPGP key material, but
     it's important to review them anyways. in particular:
     
     * when prompted for whom to add (`a GPG search`), enter the full
       `$FINGERPRINT` verified above

     * the email forward is likely to be incorrect if the key has
       multiple email address as UIDs

  2. synchronize the change:
  
          sudo -u sshdist ud-generate && sudo -H ud-replicate

## on the email server

This is currently `eugeni`.

  1. synchronize the change:
  
         sudo -H ud-replicate

  2. verify the email alias was correctly created:
  
         egrep -q "${NEW_USER}@torproject.org" /etc/postfix/debian || echo "new user missing, please fix"

  3. run puppet:

         sudo puppet agent -t

# Creating a role acount and a group for it

1. Do _not_ use ud-groupadd and ud-roleadd. They are partly broken.

2. On LDAP host (currently alberti.tpo), as a user with LDAP write access, do
  - `ldapvi -ZZ --encoding=ASCII --ldap-conf -h db.torproject.org -D uid=${USER},ou=users,dc=torproject,dc=org`
  - Cut and paste a gid entry, pick a nice gidNumber.
  - Cut and paste a uid entry, pick a nice uidNumber.
  - Add 'allowedGroups: NEW-GROUP' to host entry/ies that should have
    this role account.
3. `sudo -u sshdist ud-generate && sudo -H ud-replicate`
